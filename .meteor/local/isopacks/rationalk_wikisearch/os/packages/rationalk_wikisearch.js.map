{"version":3,"sources":["rationalk:wikisearch/lib/methods.js","rationalk:wikisearch/lib/collections.js","rationalk:wikisearch/lib/routes.js"],"names":[],"mappings":";;;;;;;;AAAA,Y;AACA,yB;AACA,iC;AACA,G;AACA,uF;AACA,G;AACA,E;;AAEA,4C;AACA,iE;AACA,E;;AAEA,8C;AACA,S;AACA,e;AACA,Q;AACA,Q;AACA,U;AACA,e;AACA,0B;AACA,6B;AACA,+B;AACA,kC;AACA,oD;AACA,+E;AACA,mE;AACA,gG;AACA,+C;AACA,kC;AACA,sC;AACA,2C;AACA,W;AACA,8C;AACA,mB;AACA,iC;AACA,0B;AACA,qB;AACA,oC;AACA,gC;AACA,gC;AACA,6B;AACA,Y;AACA,W;AACA,+B;AACA,kC;AACA,qC;AACA,6E;AACA,8E;AACA,0E;;AAEA,wC;AACA,wC;AACA,mB;AACA,oB;AACA,wC;AACA,uC;AACA,uC;AACA,qD;AACA,sD;AACA,4C;AACA,0C;AACA,4C;AACA,wD;AACA,W;AACA,gB;AACA,6B;AACA,W;AACA,kD;AACA,wC;AACA,sC;AACA,oC;AACA,W;AACA,gB;AACA,yB;AACA,W;AACA,0B;AACA,sC;AACA,0C;AACA,wC;AACA,S;AACA,O;AACA,oB;AACA,8B;AACA,0B;AACA,O;AACA,K;AACA,G;AACA,Q;AACA,iF;AACA,G;;AAEA,8B;AACA,K;AACA,c;AACA,6B;AACA,Q;AACA,M;AACA,K;AACA,gD;AACA,8C;AACA,gB;AACA,O;AACA,Y;AACA,E;;AAEA,gC;AACA,uF;AACA,E;;;;;;;;;;;;;;;;;;;AC3GA,8D;;AAEA,0B;AACA,iD;AACA,gD;AACA,kD;AACA,G;;AAEA,sB;AACA,2D;AACA,yE;AACA,E;AACA,O;AACA,6D;AACA,0E;AACA,G;AACA,E;AACA,C;;AAEA,yD;;;;;;;;;;;;;;;;;;;ACnBA,uC;AACA,I;AACA,6C;AACA,uB;AACA,yB;AACA,c;AACA,2F;AACA,Q;AACA,M;AACA,K;;AAEA,6D;AACA,qK;;AAEA,0B;AACA,K;AACA,2B;AACA,4C;AACA,K;AACA,I;AACA,I;AACA,C","file":"/packages/rationalk_wikisearch.js","sourcesContent":["RKWiki = {};\nRKWiki.Collections =  {};\nRKCore.searchResultsPackage.push(\n  {\n    name: \"RKWiki\", // a publication with the name : RKWiki-searchResults should exists\n  }\n);\n\nRKWiki.findAllFullTextSearch = function () {\n  return WikiSearchResults.find({}, {sort: {score: -1}}).fetch();\n};\n\nRKWiki.findFullText = function (searchQuery) {\n  var sr;\n  var response;\n  var i;\n  var j;\n  var obj;\n  var nResults;\n  var query = searchQuery;\n  check(searchQuery, String);\n  WikiSearchResults.remove({});\n  RKCore.log(\"Searching wiki...\");\n  if (typeof Meteor.settings.wiki !== 'undefined') {\n    //action=query&titles=Main%20Page&prop=revisions&rvprop=content&format=json\n    //action=opensearch&format=json&search=test&limit=2&format=json\n    //http://www.imfdb.org/api.php?action=opensearch&format=json&search=test&limit=2&format=json\n    endpoints = Meteor.settings.wiki.endpoints;\n    nEndpoints = endpoints.length;\n    for (j = 0; j < nEndpoints; j++) {\n      endpoint = endpoints[j] + \"/api.php\";\n      try {\n        response = Meteor.http.get(endpoint, {\n          params: {\n            action: \"opensearch\",\n            search: query,\n            limit: 5,\n            //titles: \"Main%20Page\",\n            //prop: \"revisions\",\n            //rvprop: \"content\",\n            \"format\": \"json\",\n          },\n        });\n        //RKCore.log(response);\n        RKCore.log(response.data);\n        queryWiki = response.data[0];\n        articleTitles = response.data[1]; // this is an array of size : limit\n        articleContent = response.data[2]; // this is an array of size : limit\n        articleUrl = response.data[3]; // this is an array of size : limit\n\n        nResults = articleTitles.length;\n        for (i = 0; i < nResults; i++) {\n          obj = {};\n          full = '';\n          RKCore.log(\"articleTitle : \");\n          RKCore.log(articleTitles[i]);\n          obj.title = articleTitles[i];\n          full = full.concat(' ' + articleTitles[i]);\n          if (typeof articleContent !== 'undefined') {\n            RKCore.log(\"articleContent : \");\n            RKCore.log(articleContent[i]);\n            obj.content = articleContent[i];\n            full = full.concat(' ' + articleContent[i]);\n          }\n          else {\n            obj.content = \"\";\n          }\n          if (typeof articleUrl !== 'undefined') {\n            RKCore.log(\"articleUrl : \");\n            RKCore.log(articleUrl[i]);\n            obj.url = articleUrl[i];\n          }\n          else {\n            obj.url = \"\";\n          }\n          obj.full = full;\n          obj.endpoint = endpoints[j];\n          obj.searchResultFromWiki = true;\n          WikiSearchResults.insert(obj);\n        }\n      }\n      catch(error) {\n        RKCore.log(\"Error :\");\n        RKCore.log(error);\n      }\n    }\n  }\n  else {\n    RKCore.log(\"You need to defined wiki in your settings file : settings.json\");\n  }\n\n  sr = WikiSearchResults.find(\n    {\n      $text: {\n        $search: searchQuery,\n      },\n    },\n    {\n      fields: { score: { $meta: 'textScore' } },\n      sort: { score: { $meta: 'textScore' } },\n      limit: 30,\n    });\n  return sr;\n};\n\nRKWiki.findDummy = function () {\n  return WikiSearchResults.find({$text: { $search: \"somethingthatyouwillneverfind\" }});\n};\n","WikiSearchResults = new Mongo.Collection('wikisearchresults');\n\nWikiSearchResults.allow( {\n\t\tinsert: function (userId) {return !! userId; },\n\t\tupdate: function (userId) {return !!userId; },\n    remove: function (userId) {return !!userId; },\n});\n\nif (Meteor.isServer) {\n\tif (typeof WikiSearchResults.createIndex === 'function') {\n\t\tWikiSearchResults.createIndex({ full: \"text\" }, { name: \"TextIndex\" });\n\t}\n\telse {\n\t\tif (typeof WikiSearchResults._ensureIndex === 'function') {\n\t\t\tWikiSearchResults._ensureIndex( { full: \"text\" }, {name: \"TextIndex\"});\n\t\t}\n\t}\n}\n\nRKWiki.Collections.WikiSearchResults = WikiSearchResults;\n","if (Meteor.settings.public.show.wiki) {\n  /*\n  Router.route(\"/wiki/search/:searchQuery\", {\n    name: \"wikisearch\",\n    waitOn: function () {\n      return [\n        Meteor.subscribe(\"wikisearchresults\", this.params.searchQuery), //this.params.query\n      ];\n    },\n  });\n\n  url = Router.routes.wikisearch.path({searchQuery: \"test\"});\n  menuHTML = new Spacebars.SafeString('<li><a href=\"' + url + '\" title=\"Wiki Search\"><strong><span class=\"glyphicon glyphicon-user\"></span></strong> Wiki</a></li>');\n\n  RKCore.packageMenu.push(\n    {\n      \"menuHTML\": menuHTML,\n      \"fromPackage\": \"rationalk:wikisearch\",\n    }\n  );\n  */\n}\n"]}